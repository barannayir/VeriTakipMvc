@using VeriTakipMvc.ViewNodels;
@model AdminDeviceVM


<head>
    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>
<div class="col-12">
    <div class="card">
        <div class="card-header">
            <div class="col-sm-6"><h3 class="card-title"><h3>Company List</h3></div>
            <div class="col-sm-3 offset-sm-10">
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#exampleModal">
                    Cihaz Ekle
                </button>
                <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <form asp-controller="Admin" asp-action="AddDevice" method="post" enctype="multipart/form-data">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">Yeni Cihaz</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label asp-for="Device.DeviceName">Company Name:</label>
                                        <input asp-for="Device.DeviceName" type="text" class="form-control form-control-border" name="DeviceName" id="exampleInputBorder" placeholder="DeviceName" value="">

                                        <label asp-for="Device.CompanyId">CompanyId:</label>
                                        <input asp-for="Device.CompanyId" type="text" class="form-control form-control-border" name="CompanyId" id="exampleInputBorder" placeholder="CompanyId" value="">
                                        
                                        <label asp-for="Device.DeviceGroup">DeviceGroup:</label>
                                        <input asp-for="Device.DeviceGroup" type="text" class="form-control form-control-border" name="DeviceGroup" id="exampleInputBorder" placeholder="DeviceGroup" value="">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Save changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body">
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>DeviceId</th>
                        <th>CompanyID</th>
                        <th>Device Name</th>
                        <th>DeviceLocation</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <input type="hidden" id="cookieValue" value="@ViewBag.cookieValue" />
                <tbody>
                    @foreach (var item in Model.Devices)
                    {

                        <tr data-widget="expandable-table" aria-expanded="false">
                            <td>@item.Id</td>
                            <td>@item.CompanyId</td>
                            <td>@item.DeviceName</td>
                            <td>@item.DeviceGroup</td>
                            <td>@item.IsDeviceOnAlert</td>
                        </tr>
                        <tr class="expandable-body d-none">
                            
                    <td></td>
                    <td>
                        <a asp-action="DeviceDetail" class="btn btn-block btn-primary details-button" asp-route-id="@item.Id">Detay</a>
                    </td>
                    <td>
                        <a asp-action="EditDevice" class="btn btn-block btn-warning" asp-route-id="@item.Id"><i class="fa fa-marker"></i></a>
                    </td>
                    <td>

                        <form method="post" asp-action="DeleteDevice" asp-route-id="@item.Id">
                            <input type="hidden" name="deviceId" value="@item.Id" />
                            <button type="submit" class="btn btn-danger"><i class="fa fa-trash" onclick="return confirm('Are you sure you want to delete this?')"></i></button>
                        </form>
                    </td>

                    </tr>
                    }
                </tbody>
            </table>
        </div>

    </div>

</div>
<script>
    //$(document).ready(function () {
    //    // Detay görüntüle butonuna click event listener ekle
    //    $('table').on('click', 'button.btn-primary', function () {
    //        var deviceId = $(this).closest('tr').data('device-id');
    //        var token = getCookie('jwtToken');
    //        var apiUrl = 'https://localhost:5001/api/device/details/' + deviceId;

    //        // Ajax isteği gönder
    //        $.ajax({
    //            url: apiUrl,
    //            type: 'GET',
    //            xhrFields: {
    //                withCredentials: true
    //            },
    //            success: function (data) {
    //                console.log(data);
    //            },
    //            error: function (xhr, status, error) {
    //                console.log(status);

    //            }
    //        });

    var cookieValue = $("#cookieValue").val();

    $(document).on("click", ".details-button", function () {
        var deviceId = $(this).attr("id").split("-")[1];
        var token = 0; // Önce önceden kaydettiğimiz token'ı alıyoruz.
        console.log(deviceId);
        $.ajax({
            type: 'POST',
            url: 'https://localhost:44301/api/Home/TokenControl?com=' + deviceId, // API'nin adresini buraya yazabilirsin.
            headers: {
                'Authorization': 'Bearer ' + cookieValue // API'ye yetkilendirme bilgisini gönderiyoruz.
            },
            data: { deviceId: deviceId },
            success: function (result) {
                // İşlem başarılı olursa burada yapılacak işlemler.
                console.log(result);
            },
            error: function (xhr, status, error) {
                // İşlem başarısız olursa burada yapılacak işlemler.
                console.log(xhr.responseText);
            }
        });
    });


    function getCookie(cname) {
        let name = cname + "=";
        let ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                console.log(c.substring(name.length, c.length));
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }



</script>